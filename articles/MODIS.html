<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1. Processing MODIS data with gdalcubes • gdalcubes</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1. Processing MODIS data with gdalcubes">
<meta property="og:description" content="gdalcubes">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">gdalcubes</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MODIS.html">1. Processing MODIS data with gdalcubes</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/appelmar/gdalcubes_R/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1. Processing MODIS data with gdalcubes</h1>
                        <h4 class="author">Marius Appel</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/appelmar/gdalcubes_R/blob/master/vignettes/MODIS.Rmd"><code>vignettes/MODIS.Rmd</code></a></small>
      <div class="hidden name"><code>MODIS.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>The gdalcubes R package aims at making the work with large collections of Earth observation (EO) imagery (e.g. from <a href="https://sentinel.esa.int/web/sentinel/missions/sentinel-2">Sentinel 2</a>) <strong>easier</strong> and <strong>faster</strong>. Typical challenges with these data such as overlapping images, different spatial resolutions of spectral bands, irregular temporal sampling, and different spatial reference systems become invisible to users by reading the data as a raster data cube and letting users define the shape of the cube (spatiotemporal extent, resolution, and spatial reference system). Working with EO imagery then becomes more interactive: going from “<em>try my method on low resolution and get the result asap</em>” to “<em>apply my final method to the full resolution dataset over night</em>” becomes straightforward.</p>
<p>This brief vignette illustrates basic ideas of the package. We will use satellite imagary from the Moderate Resolution Imaging Spectroradiometer (<a href="https://modis.gsfc.nasa.gov">MODIS</a>) that is small enough to process even on older machines. The imagery comes as a set of <a href="https://support.hdfgroup.org/products/hdf4/">HDF4</a> files. We assume that you have successfully installed the gdalcubes R package. Please also make sure that your GDAL installation supports the HDF4 driver (e.g. with <code><a href="../reference/gdalcubes_gdalformats.html">gdalcubes_gdalformats()</a></code>).</p>
<p>In the following, we will follow a simple workflow by</p>
<ol style="list-style-type: decimal">
<li>indexing image files in an <strong>image collection</strong>,</li>
<li>creating data cubes at various spatiotemporal resolutions and extents, and</li>
<li>applying simple operations on data cubes including band selection, application of pixel-wise functions, reduction over time, and time series filtering.</li>
</ol>
</div>
<div id="downloading-the-sample-data" class="section level1">
<h1 class="hasAnchor">
<a href="#downloading-the-sample-data" class="anchor"></a>Downloading the sample data</h1>
<p>We will use 8-daily land surface temperature from the MODIS product <a href="https://modis.gsfc.nasa.gov/data/dataprod/mod11.php">MOD11A2</a>, covering western Europe (tiles v=13,14, h=03,04) from January to September 2018. The zip archive has approximately 600 megabytes. The code below downloads and unzips the data to the current working directory.</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="no">dest_dir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span>()
<span class="fu"><a href="https://rdrr.io/r/utils/download.file.html">download.file</a></span>(<span class="st">"https://uni-muenster.sciebo.de/s/eP9E6OIkQbXrmsY/download"</span>, <span class="kw">destfile</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">dest_dir</span>, <span class="st">"MOD11A2.zip"</span>),<span class="kw">mode</span> <span class="kw">=</span> <span class="st">"wb"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/unzip.html">unzip</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">dest_dir</span>, <span class="st">"MOD11A2.zip"</span>), <span class="kw">exdir</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">dest_dir</span>,<span class="st">"MOD11A2"</span>))
<span class="fu"><a href="https://rdrr.io/r/base/unlink.html">unlink</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">dest_dir</span>, <span class="st">"MOD11A2.zip"</span>))</pre></body></html></div>
</div>
<div id="creating-an-image-collection" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-an-image-collection" class="anchor"></a>Creating an image collection</h1>
<p>As a first step, we must combine the set of files for the first MODIS product (MOD11A2) in a single <em>image collection</em>. The image collection is a simple index, pointing to files and storing the spatial extent, spatial reference system, aquisition date/time of images and how files relate to image bands. The package comes with a set of predefined rules (called <em>image collection formats</em>), how this information can be extracted from filenames for selected EO products. A list of available collection formats including a short description can be printed with:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gdalcubes</span>)
<span class="fu"><a href="../reference/collection_formats.html">collection_formats</a></span>()
<span class="co">##    CHIRPS_v2_0_daily_p05_tif | Image collection format for CHIRPS v 2.0 daily</span>
<span class="co">##                              | global precipitation dataset (0.05 degrees</span>
<span class="co">##                              | resolution) from GeoTIFFs, expects list of .tif</span>
<span class="co">##                              | or .tif.gz files as input. [TAGS: CHIRPS,</span>
<span class="co">##                              | precipitation]</span>
<span class="co">##  CHIRPS_v2_0_monthly_p05_tif | Image collection format for CHIRPS v 2.0 monthly</span>
<span class="co">##                              | global precipitation dataset (0.05 degrees</span>
<span class="co">##                              | resolution) from GeoTIFFs, expects list of .tif</span>
<span class="co">##                              | or .tif.gz files as input. [TAGS: CHIRPS,</span>
<span class="co">##                              | precipitation]</span>
<span class="co">##            ESA_CCI_SM_ACTIVE | Collection format for ESA CCI soil moisture</span>
<span class="co">##                              | active product (version 4.7) [TAGS: Soil</span>
<span class="co">##                              | Moisture, ESA, CCI]</span>
<span class="co">##           ESA_CCI_SM_PASSIVE | Collection format for ESA CCI soil moisture</span>
<span class="co">##                              | passive product (version 4.7) [TAGS: Soil</span>
<span class="co">##                              | Moisture, ESA, CCI]</span>
<span class="co">##    GPM_IMERG_3B_DAY_GIS_V06A | Collection format for daily</span>
<span class="co">##                              | IMERG_3B_DAY_GIS_V06A data [TAGS: Precipitation,</span>
<span class="co">##                              | GPM, IMERG]</span>
<span class="co">##                      L8_L1TP | Collection format for Landsat 8 Level 1 TP</span>
<span class="co">##                              | product [TAGS: Landsat, USGS, Level 1, NASA]</span>
<span class="co">##                        L8_SR | Collection format for Landsat 8 surface</span>
<span class="co">##                              | reflectance product [TAGS: Landsat, USGS, Level</span>
<span class="co">##                              | 2, NASA, surface reflectance]</span>
<span class="co">##                      MxD09GA | Collection format for selected bands from the</span>
<span class="co">##                              | MODIS MxD09GA (Aqua and Terra) product [TAGS:</span>
<span class="co">##                              | MODIS, surface reflectance]</span>
<span class="co">##                      MxD10A2 | Collection format for selected bands from the</span>
<span class="co">##                              | MODIS MxD10A2 (Aqua and Terra) v006 Snow Cover</span>
<span class="co">##                              | product [TAGS: MODIS, Snow Cover]</span>
<span class="co">##                      MxD11A1 | Collection format for selected bands from the</span>
<span class="co">##                              | MODIS MxD11A2 (Aqua and Terra) v006 Land Surface</span>
<span class="co">##                              | Temperature product [TAGS: MODIS, LST]</span>
<span class="co">##                      MxD11A2 | Collection format for selected bands from the</span>
<span class="co">##                              | MODIS MxD11A2 (Aqua and Terra) v006 Land Surface</span>
<span class="co">##                              | Temperature product [TAGS: MODIS, LST]</span>
<span class="co">##                      MxD13A2 | Collection format for selected bands from the</span>
<span class="co">##                              | MODIS MxD13A2 (Aqua and Terra) product [TAGS:</span>
<span class="co">##                              | MODIS, VI, NDVI, EVI]</span>
<span class="co">##                      MxD13A3 | Collection format for selected bands from the</span>
<span class="co">##                              | MODIS MxD13A3 (Aqua and Terra) product [TAGS:</span>
<span class="co">##                              | MODIS, VI, NDVI, EVI]</span>
<span class="co">##                      MxD13Q1 | Collection format for selected bands from the</span>
<span class="co">##                              | MODIS MxD13Q1 (Aqua and Terra) product [TAGS:</span>
<span class="co">##                              | MODIS, VI, NDVI, EVI]</span>
<span class="co">##                      MxD14A2 | Collection format for the MODIS MxD14A2 (Aqua</span>
<span class="co">##                              | and Terra) product [TAGS: MODIS, Fire]</span>
<span class="co">## PlanetScope_3B_AnalyticMS_SR | Image collection format for PlanetScope 4-band</span>
<span class="co">##                              | scenes [TAGS: PlanetScope, BOA, Surface</span>
<span class="co">##                              | Reflectance]</span>
<span class="co">##             Sentinel1_IW_GRD | Image collection format for Sentinel 1 Level 1</span>
<span class="co">##                              | GRD data as downloaded from the Copernicus Open</span>
<span class="co">##                              | Access Hub, expects a list of file paths as</span>
<span class="co">##                              | input. The format works on original ZIP</span>
<span class="co">##                              | compressed as well as uncompressed imagery.</span>
<span class="co">##                              | [TAGS: Sentinel, Copernicus, ESA, SAR]</span>
<span class="co">##                Sentinel2_L1C | Image collection format for Sentinel 2 Level 1C</span>
<span class="co">##                              | data as downloaded from the Copernicus Open</span>
<span class="co">##                              | Access Hub, expects a list of file paths as</span>
<span class="co">##                              | input. The format works on original ZIP</span>
<span class="co">##                              | compressed as well as uncompressed imagery.</span>
<span class="co">##                              | [TAGS: Sentinel, Copernicus, ESA, TOA]</span>
<span class="co">##            Sentinel2_L1C_AWS | Image collection format for Sentinel 2 Level 1C</span>
<span class="co">##                              | data in AWS [TAGS: Sentinel, Copernicus, ESA,</span>
<span class="co">##                              | TOA]</span>
<span class="co">##                Sentinel2_L2A | Image collection format for Sentinel 2 Level 2A</span>
<span class="co">##                              | data as downloaded from the Copernicus Open</span>
<span class="co">##                              | Access Hub, expects a list of file paths as</span>
<span class="co">##                              | input. The format should work on original ZIP</span>
<span class="co">##                              | compressed as well as uncompressed imagery.</span>
<span class="co">##                              | [TAGS: Sentinel, Copernicus, ESA, BOA, Surface</span>
<span class="co">##                              | Reflectance]</span>
<span class="co">##          Sentinel2_L2A_THEIA | Image collection format for Sentinel 2 Level 2A</span>
<span class="co">##                              | data as downloaded from Theia. [TAGS: Sentinel,</span>
<span class="co">##                              | ESA, Flat Reflectance, Theia]</span></pre></body></html></div>
<p>In this case, <code>MxD11A2</code> is the correct format for our datasets. Internally, collection formats are defined in relatively simple JSON files, presets for other products will be added continuously.</p>
<p>To create the image collection, we must pass a list of our files and the collection format to the <code><a href="../reference/create_image_collection.html">create_image_collection()</a></code> function. The code below finds all files as character vector of GDAL datasets, which then can be passed as first argument to <code><a href="../reference/create_image_collection.html">create_image_collection()</a></code>. The second argument here referes to the image collection format and the third argument provides the name of the output image collection file (which is simply an SQLite database). The collection format also knows that bands are stored as subdatasets in the HDF files.</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">img_col_file</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempfile</a></span>(<span class="kw">fileext</span><span class="kw">=</span><span class="st">".db"</span>)
<span class="no">files</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span>(<span class="no">dest_dir</span>,<span class="st">"MOD11A2"</span>), <span class="kw">pattern</span><span class="kw">=</span><span class="st">".hdf$"</span>, <span class="kw">full.names</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="fu"><a href="../reference/create_image_collection.html">create_image_collection</a></span>(<span class="no">files</span>, <span class="st">"MxD11A2"</span>, <span class="no">img_col_file</span>)
<span class="co">## A GDAL image collection object, referencing 140 images with 8  bands</span>
<span class="co">## Images:</span>
<span class="co">##                                                                name      left</span>
<span class="co">## 1 /tmp/RtmpKgLLYJ/MOD11A2/MOD11A2.A2018001.h17v03.006.2018011145329 -20.00000</span>
<span class="co">## 2 /tmp/RtmpKgLLYJ/MOD11A2/MOD11A2.A2018001.h17v04.006.2018011145438 -15.55724</span>
<span class="co">## 3 /tmp/RtmpKgLLYJ/MOD11A2/MOD11A2.A2018001.h18v03.006.2018011145428   0.00000</span>
<span class="co">## 4 /tmp/RtmpKgLLYJ/MOD11A2/MOD11A2.A2018001.h18v04.006.2018011145326   0.00000</span>
<span class="co">## 5 /tmp/RtmpKgLLYJ/MOD11A2/MOD11A2.A2018009.h17v03.006.2018018034330 -20.00000</span>
<span class="co">## 6 /tmp/RtmpKgLLYJ/MOD11A2/MOD11A2.A2018009.h17v04.006.2018018034246 -15.55724</span>
<span class="co">##   top bottom    right            datetime</span>
<span class="co">## 1  60     50  0.00000 2018-01-01T00:00:00</span>
<span class="co">## 2  50     40  0.00000 2018-01-01T00:00:00</span>
<span class="co">## 3  60     50 20.00000 2018-01-01T00:00:00</span>
<span class="co">## 4  50     40 15.55724 2018-01-01T00:00:00</span>
<span class="co">## 5  60     50  0.00000 2018-01-09T00:00:00</span>
<span class="co">## 6  50     40  0.00000 2018-01-09T00:00:00</span>
<span class="co">##                                                                  srs</span>
<span class="co">## 1 +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs</span>
<span class="co">## 2 +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs</span>
<span class="co">## 3 +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs</span>
<span class="co">## 4 +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs</span>
<span class="co">## 5 +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs</span>
<span class="co">## 6 +proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs</span>
<span class="co">## [ omitted 134 images ] </span>
<span class="co">## </span>
<span class="co">## Bands:</span>
<span class="co">##              name offset scale unit     nodata image_count</span>
<span class="co">## 1   DAY_VIEW_TIME   0.00 0.100  hrs 255.000000         140</span>
<span class="co">## 2         EMIS_31   0.49 0.002        0.000000         140</span>
<span class="co">## 3         EMIS_32   0.49 0.002        0.000000         140</span>
<span class="co">## 4         LST_DAY   0.00 0.020    K   0.000000         140</span>
<span class="co">## 5       LST_NIGHT   0.00 0.020    K   0.000000         140</span>
<span class="co">## 6 NIGHT_VIEW_TIME   0.00 0.100  hrs 255.000000         140</span>
<span class="co">## 7          QC_DAY   0.00 1.000                         140</span>
<span class="co">## 8        QC_NIGHT   0.00 1.000                         140</span></pre></body></html></div>
</div>
<div id="creating-a-data-cube" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-a-data-cube" class="anchor"></a>Creating a data cube</h1>
<p>The created image collection has references to original images on disk and knows about the datetime, spatial extent, and coordinate reference system of images. The <code><a href="../reference/raster_cube.html">raster_cube()</a></code> function creates a data cube from an image collection. This function expects up to three arguments:</p>
<ol style="list-style-type: decimal">
<li>an image collection object as created above,</li>
<li>a data cube view defining the spatiotemporal resolution and extent and the spatial reference system of the target cube, and</li>
<li>the internal size of chunks how the cube is partitioned in memory</li>
</ol>
<p>If no data cube view is provided, a default cube that covers the whole extent of the collection at low resolution is created. The chunk size defaults to (16 x 256 x 256) pixels in time, y, and x directions. Below, we create a data cube with a default cube view and print some basic information about its dimensions and bands.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">x</span> <span class="kw">=</span> <span class="fu"><a href="../reference/raster_cube.html">raster_cube</a></span>(<span class="fu"><a href="../reference/image_collection.html">image_collection</a></span>(<span class="no">img_col_file</span>))
<span class="no">x</span>
<span class="co">## A GDAL data cube proxy object</span>
<span class="co">## </span>
<span class="co">## Dimensions:</span>
<span class="co">##                 low             high count       pixel_size chunk_size</span>
<span class="co">## t           2018-01          2018-10     4              P3M          1</span>
<span class="co">## y  4447802.07906609 6671703.11859914   413 5384.74827974103        256</span>
<span class="co">## x -1703607.03338081 1703607.03338081   633 5382.64465523162        256</span>
<span class="co">## </span>
<span class="co">## Bands:</span>
<span class="co">##              name offset scale nodata unit</span>
<span class="co">## 1   DAY_VIEW_TIME   0.00 0.100    NaN  hrs</span>
<span class="co">## 2         EMIS_31   0.49 0.002    NaN     </span>
<span class="co">## 3         EMIS_32   0.49 0.002    NaN     </span>
<span class="co">## 4         LST_DAY   0.00 0.020    NaN    K</span>
<span class="co">## 5       LST_NIGHT   0.00 0.020    NaN    K</span>
<span class="co">## 6 NIGHT_VIEW_TIME   0.00 0.100    NaN  hrs</span>
<span class="co">## 7          QC_DAY   0.00 1.000    NaN     </span>
<span class="co">## 8        QC_NIGHT   0.00 1.000    NaN</span>

<span class="fu"><a href="../reference/bands.html">bands</a></span>(<span class="no">x</span>)
<span class="co">##              name offset scale nodata unit</span>
<span class="co">## 1   DAY_VIEW_TIME   0.00 0.100    NaN  hrs</span>
<span class="co">## 2         EMIS_31   0.49 0.002    NaN     </span>
<span class="co">## 3         EMIS_32   0.49 0.002    NaN     </span>
<span class="co">## 4         LST_DAY   0.00 0.020    NaN    K</span>
<span class="co">## 5       LST_NIGHT   0.00 0.020    NaN    K</span>
<span class="co">## 6 NIGHT_VIEW_TIME   0.00 0.100    NaN  hrs</span>
<span class="co">## 7          QC_DAY   0.00 1.000    NaN     </span>
<span class="co">## 8        QC_NIGHT   0.00 1.000    NaN</span>
<span class="fu"><a href="../reference/dimensions.html">dimensions</a></span>(<span class="no">x</span>)
<span class="co">## $t</span>
<span class="co">## $t$low</span>
<span class="co">## [1] "2018-01"</span>
<span class="co">## </span>
<span class="co">## $t$high</span>
<span class="co">## [1] "2018-10"</span>
<span class="co">## </span>
<span class="co">## $t$count</span>
<span class="co">## [1] 4</span>
<span class="co">## </span>
<span class="co">## $t$pixel_size</span>
<span class="co">## [1] "P3M"</span>
<span class="co">## </span>
<span class="co">## $t$chunk_size</span>
<span class="co">## [1] 1</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## $y</span>
<span class="co">## $y$low</span>
<span class="co">## [1] 4447802</span>
<span class="co">## </span>
<span class="co">## $y$high</span>
<span class="co">## [1] 6671703</span>
<span class="co">## </span>
<span class="co">## $y$count</span>
<span class="co">## [1] 413</span>
<span class="co">## </span>
<span class="co">## $y$pixel_size</span>
<span class="co">## [1] 5384.748</span>
<span class="co">## </span>
<span class="co">## $y$chunk_size</span>
<span class="co">## [1] 256</span>
<span class="co">## </span>
<span class="co">## </span>
<span class="co">## $x</span>
<span class="co">## $x$low</span>
<span class="co">## [1] -1703607</span>
<span class="co">## </span>
<span class="co">## $x$high</span>
<span class="co">## [1] 1703607</span>
<span class="co">## </span>
<span class="co">## $x$count</span>
<span class="co">## [1] 633</span>
<span class="co">## </span>
<span class="co">## $x$pixel_size</span>
<span class="co">## [1] 5382.645</span>
<span class="co">## </span>
<span class="co">## $x$chunk_size</span>
<span class="co">## [1] 256</span>
<span class="fu"><a href="../reference/srs.html">srs</a></span>(<span class="no">x</span>)
<span class="co">## [1] "+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +R=6371007.181 +units=m +no_defs"</span></pre></body></html></div>
<p>Notice that <code><a href="../reference/raster_cube.html">raster_cube()</a></code> will not run any computations besides deriving the shape of the output cube. Instead, it will return a <em>proxy</em> object that will not be evaluated until data must be actually read (e.g. when calling <code>plot</code>). This not only applies to data cubes from image collections but also for derived cubes (see further below). In most cases, however, users want to specify the extent and resolution manually. Above, the temporal resolution of the cube was 3 months whereas below, we define a custom data cube view with temporal resolution of one month.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">srs</span><span class="kw">=</span><span class="st">"+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs"</span>
<span class="no">MOD11A2.col</span> <span class="kw">=</span> <span class="fu"><a href="../reference/image_collection.html">image_collection</a></span>(<span class="no">img_col_file</span>)
<span class="no">v</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cube_view.html">cube_view</a></span>(<span class="kw">srs</span><span class="kw">=</span><span class="no">srs</span>, <span class="kw">extent</span><span class="kw">=</span><span class="no">MOD11A2.col</span>, <span class="kw">nx</span> <span class="kw">=</span> <span class="fl">400</span>, <span class="kw">dt</span><span class="kw">=</span><span class="st">"P1M"</span>, <span class="kw">aggregation</span> <span class="kw">=</span> <span class="st">"mean"</span>)
<span class="no">v</span>
<span class="co">## A data cube view object</span>
<span class="co">## </span>
<span class="co">## Dimensions:</span>
<span class="co">##                 low             high count       pixel_size</span>
<span class="co">## t           2018-01          2018-09     9              P1M</span>
<span class="co">## y  4447802.07906609 6671703.11859914   261 8520.69363805765</span>
<span class="co">## x -1703607.03338081 1703607.03338081   400 8518.03516690404</span>
<span class="co">## </span>
<span class="co">## SRS: "+proj=sinu +lon_0=0 +x_0=0 +y_0=0 +a=6371007.181 +b=6371007.181 +units=m +no_defs"</span>
<span class="co">## Temporal aggregation method: "mean"</span>
<span class="co">## Spatial resampling method: "near"</span>
<span class="no">MOD11A2.cube</span> <span class="kw">=</span> <span class="fu"><a href="../reference/raster_cube.html">raster_cube</a></span>(<span class="no">MOD11A2.col</span>, <span class="no">v</span>)
<span class="no">MOD11A2.cube</span>
<span class="co">## A GDAL data cube proxy object</span>
<span class="co">## </span>
<span class="co">## Dimensions:</span>
<span class="co">##                 low             high count       pixel_size chunk_size</span>
<span class="co">## t           2018-01          2018-09     9              P1M          1</span>
<span class="co">## y  4447802.07906609 6671703.11859914   261 8520.69363805765        256</span>
<span class="co">## x -1703607.03338081 1703607.03338081   400 8518.03516690404        256</span>
<span class="co">## </span>
<span class="co">## Bands:</span>
<span class="co">##              name offset scale nodata unit</span>
<span class="co">## 1   DAY_VIEW_TIME   0.00 0.100    NaN  hrs</span>
<span class="co">## 2         EMIS_31   0.49 0.002    NaN     </span>
<span class="co">## 3         EMIS_32   0.49 0.002    NaN     </span>
<span class="co">## 4         LST_DAY   0.00 0.020    NaN    K</span>
<span class="co">## 5       LST_NIGHT   0.00 0.020    NaN    K</span>
<span class="co">## 6 NIGHT_VIEW_TIME   0.00 0.100    NaN  hrs</span>
<span class="co">## 7          QC_DAY   0.00 1.000    NaN     </span>
<span class="co">## 8        QC_NIGHT   0.00 1.000    NaN</span></pre></body></html></div>
<div id="aggregation-and-resampling" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregation-and-resampling" class="anchor"></a>Aggregation and resampling</h2>
<p>Besides the spatiotemporal extent, the resolution and the spatial reference system, the data cube view contains the two important parameters <code>aggregation</code> and <code>resampling</code>. Resampling here refers to how images are resampled in space during the warp operation. The temporal aggregation method defines how values for the same cell from different images are combined in the target cube. For example, a data cube with monthly temporal resolution will contain values from multiple images. Currently, possible values are first, last, min, max, mean, and median. These functions are evaluated per data cube pixel.</p>
</div>
</div>
<div id="data-cube-operations" class="section level1">
<h1 class="hasAnchor">
<a href="#data-cube-operations" class="anchor"></a>Data cube operations</h1>
<p>The package comes with a few operations on data cubes to (i) select bands (<code><a href="../reference/select_bands.html">select_bands()</a></code>), (ii) apply pixel-wise arithmetic expressions (<code><a href="../reference/apply_pixel.html">apply_pixel()</a></code>), (iii) reduce data cubes over space and time (<code><a href="../reference/reduce_time.html">reduce_time()</a></code>, <code><a href="../reference/reduce_space.html">reduce_space()</a></code>), apply a moving-window function over time (<code><a href="../reference/window_time.html">window_time()</a></code>), (iv) apply an R function over chunks of a data cube (<code><a href="../reference/chunk_apply.html">chunk_apply()</a></code>), and (v) join bands of identically shaped data cubes (<code><a href="../reference/join_bands.html">join_bands()</a></code>). All of these functions produce a proxy data cube, storing the shape of the result cube but not any data. They all take a (proxy) data cube as first argument and can be chained. The following code demonstrates some of the operations and how data cubes can be plotted.</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">MOD11A2.bandselect</span> <span class="kw">=</span> <span class="fu"><a href="../reference/select_bands.html">select_bands</a></span>(<span class="no">MOD11A2.cube</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"LST_DAY"</span>,<span class="st">"LST_NIGHT"</span>))
<span class="no">MOD11A2.daynight_difference</span> <span class="kw">=</span> <span class="fu"><a href="../reference/apply_pixel.html">apply_pixel</a></span>(<span class="no">MOD11A2.bandselect</span>, <span class="st">"0.02*(LST_DAY-LST_NIGHT)"</span>,<span class="kw">names</span> <span class="kw">=</span> <span class="st">"LST_difference"</span>)
<span class="no">MOD11A2.reduce</span> <span class="kw">=</span> <span class="fu"><a href="../reference/reduce_time.html">reduce_time</a></span>(<span class="no">MOD11A2.daynight_difference</span>, <span class="st">"median(LST_difference)"</span>)
<span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="no">MOD11A2.reduce</span>, <span class="kw">col</span><span class="kw">=</span><span class="no">heat.colors</span>, <span class="kw">key.pos</span><span class="kw">=</span><span class="fl">1</span>)</pre></body></html></div>
<p><img src="MODIS_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The result is the median day night surface temperature difference for all pixels between Jan and December 2018. Notice that no data is actually read until we call <code><a href="https://rdrr.io/r/base/plot.html">plot()</a></code>, i.e. all operations again return <em>proxy</em> objects. Replacing the plot function with <code><a href="../reference/write_ncdf.html">write_ncdf(MOD11A2.reduce, "test.nc")</a></code> would write the result as a NetCDF file to disk.</p>
<p>Operations on data cubes are designed such that they can be used with the <a href="https://r4ds.had.co.nz/pipes.html">pipe operator</a>. The following code for example derives monthly differences of land surface temperature, from June to September 2018. The <code>window_time</code> function here applies the simple time series kernel filter <span class="math inline">\(T_t - T_{t-1}\)</span>.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">magrittr</span>) <span class="co"># get the pipe</span>
<span class="no">v1</span> <span class="kw">=</span> <span class="fu"><a href="../reference/cube_view.html">cube_view</a></span>(<span class="kw">view</span><span class="kw">=</span><span class="no">v</span>, <span class="kw">extent</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">t0</span><span class="kw">=</span><span class="st">"2018-06"</span>, <span class="kw">t1</span><span class="kw">=</span><span class="st">"2018-09"</span>))
<span class="fu"><a href="../reference/raster_cube.html">raster_cube</a></span>(<span class="fu"><a href="../reference/image_collection.html">image_collection</a></span>(<span class="no">img_col_file</span>), <span class="no">v1</span>)  <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/select_bands.html">select_bands</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"LST_DAY"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="../reference/apply_pixel.html">apply_pixel</a></span>(<span class="st">"LST_DAY * 0.02"</span>) <span class="kw">%&gt;%</span> <span class="co"># apply scale</span>
  <span class="fu"><a href="../reference/window_time.html">window_time</a></span>(<span class="kw">kernel</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">1</span>,<span class="fl">1</span>), <span class="kw">window</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="fl">1</span>,<span class="fl">0</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span>(<span class="kw">col</span><span class="kw">=</span><span class="no">terrain.colors</span>, <span class="kw">key.pos</span><span class="kw">=</span><span class="fl">1</span>, <span class="kw">zlim</span><span class="kw">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">25</span>,<span class="fl">25</span>))</pre></body></html></div>
<p><img src="MODIS_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<div id="multithreading" class="section level2">
<h2 class="hasAnchor">
<a href="#multithreading" class="anchor"></a>Multithreading</h2>
<p>gdalcubes supports multithreaded evaluation of data cube operations. Calling <code><a href="../reference/gdalcubes_set_threads.html">gdalcubes_set_threads(n)</a></code> will tell all following data cube operations to use up to <code>n</code> threads. Since worker threads are assigned to chunks of the data cube, the actual number of threads used is lower for cubes with less than <code>n</code> chunks.</p>
</div>
</div>
<div id="future-work" class="section level1">
<h1 class="hasAnchor">
<a href="#future-work" class="anchor"></a>Future work</h1>
<p>This vignette presents a very simple example with a small dataset. Future vignettes will focus on (i) how user-defined R functions can be applied on data cubes, (ii) how to process larger datasets (Sentinel 2) with overlapping images from different spatial reference systems, and (iii) how to run gdalcubes in the cloud.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Marius Appel.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
